<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
        <title>æ™¯ç‚¹ç®¡ç†</title>

        <!-- Bootstrap core CSS -->
        <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet" />

        <!-- Additional CSS Files -->
        <link rel="stylesheet" href="assets/css/fontawesome.css" />
        <link rel="stylesheet" href="assets/css/templatemo-style.css" />
        <link rel="stylesheet" href="assets/css/owl.css" />
    </head>
    <body>
        <!-- Wrapper -->
        <div id="wrapper">
            <!-- Main -->
            <div id="main">
                <div class="inner">
                    <!-- Header -->
                    <header id="header">
                        <div class="logo">
                            <a href="login.html">æ¸¸å®¢ï¼Œè¯·ç™»å½•</a>
                        </div>
                    </header>

                    <!-- Page Heading -->
                    <div class="page-heading">
                        <div class="container-fluid">
                            <div class="row">
                                <div class="col-md-12">
                                    <h1>ç®¡ç†æˆ‘å‘å¸ƒçš„æ™¯ç‚¹</h1>
                                    <p>
                                        åœ¨è¿™é‡Œå¯¹ä½ å‘å¸ƒçš„æ™¯ç‚¹è¿›è¡Œç®¡ç†ï¼
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ™¯ç‚¹ç®¡ç† -->
                    <div id="spotsList"></div>

                    <!-- ä¿®æ”¹å¼¹çª— -->
                    <div
                        class="modal fade"
                        id="editModal"
                        tabindex="-1"
                        role="dialog"
                    >
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="modalTitle">
                                        ä¿®æ”¹æ™¯ç‚¹ä¿¡æ¯
                                    </h5>
                                    <button
                                        type="button"
                                        class="close"
                                        data-dismiss="modal"
                                    >
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <form
                                    id="editForm"
                                    class="modal-body"
                                    method="post"
                                    enctype="multipart/form-data"
                                >
                                    <div class="form-group">
                                        <label for="price">ç¥¨ä»·</label>
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"
                                                    >ï¿¥</span
                                                >
                                            </div>
                                            <input
                                                type="text"
                                                onkeyup="value=value.replace(/^(-1+)|[^\d]+/g,'')"
                                                class="form-control"
                                                name="ticket"
                                                id="ticket"
                                                placeholder="ç¥¨ä»·"
                                                required
                                            />
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"
                                                    >.00</span
                                                >
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="spotDesc">æ™¯ç‚¹æè¿°</label>
                                        <textarea
                                            name="spotDesc"
                                            id="spotDesc"
                                            class="form-control"
                                            cols="30"
                                            rows="5"
                                            required
                                        ></textarea>
                                    </div>

                                    <div class="form-group">
                                        <label for="album">æ›´æ–°æ™¯ç‚¹å›¾ç‰‡</label>
                                        <div class="custom-file">
                                            <input
                                                type="file"
                                                class="custom-file-input"
                                                name="album"
                                                id="album"
                                            />
                                            <label
                                                class="custom-file-label"
                                                for="album"
                                                >ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</label
                                            >
                                        </div>
                                    </div>

                                    <div class="form-group mb-5">
                                        <label for="preview">å›¾ç‰‡é¢„è§ˆ</label>
                                        <div id="preview"></div>
                                    </div>
                                </form>
                                <div class="modal-footer">
                                    <span id="editTips"></span>
                                    <button
                                        type="button"
                                        class="btn btn-secondary"
                                        data-dismiss="modal"
                                    >
                                        å–æ¶ˆ
                                    </button>
                                    <a
                                        href="#"
                                        class="btn btn-primary"
                                        onclick="editSubmit()"
                                    >
                                        ç¡®è®¤ä¿®æ”¹
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- åˆ é™¤å¼¹çª— -->
                    <div
                        class="modal fade"
                        id="delModal"
                        tabindex="-1"
                        role="dialog"
                    >
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="delTitle">
                                        åˆ é™¤æ™¯ç‚¹
                                    </h5>
                                    <button
                                        type="button"
                                        class="close"
                                        data-dismiss="modal"
                                    >
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    æ‚¨ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ
                                </div>
                                <div class="modal-footer">
                                    <span id="delTips"></span>
                                    <button
                                        type="button"
                                        class="btn btn-secondary"
                                        data-dismiss="modal"
                                    >
                                        å–æ¶ˆ
                                    </button>
                                    <button
                                        type="submit"
                                        class="btn btn-primary"
                                        onclick="delSubmit()"
                                    >
                                        ç¡®è®¤åˆ é™¤
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- sidebar -->
            <div id="sidebar">
                <div class="inner">
                    <!-- Search Box -->
                    <section id="search" class="alt">
                        <form onsubmit="return false" id="keyWordForm">
                            <input
                                type="text"
                                id="keyword"
                                placeholder="æœç´¢æ™¯ç‚¹..."
                            />
                        </form>
                    </section>

                    <!-- Menu -->
                    <nav id="menu">
                        <ul>
                            <li><a href="index.html">æœ€æ–°æ™¯ç‚¹</a></li>
                            <li><a href="post-add.html">å‘å¸ƒæ–°æ™¯ç‚¹</a></li>
                            <li><a href="post-manage.html">æ™¯ç‚¹ç®¡ç†</a></li>
                        </ul>
                    </nav>

                    <!-- Featured Posts -->
                    <div class="featured-posts">
                        <div class="heading">
                            <h2>å…è´¹æ™¯ç‚¹æ¨è</h2>
                        </div>
                        <div id="selected" class="owl-carousel owl-theme"></div>
                    </div>

                    <!-- Footer -->
                    <footer id="footer">
                        <p class="copyright">
                            UMLè¯¾è®¾@1600300626ç‹æ°åŸ
                        </p>
                    </footer>
                </div>
            </div>
        </div>

        <!-- Scripts -->
        <!-- Bootstrap core JavaScript -->
        <script src="vendor/jquery/jquery.min.js"></script>
        <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

        <script src="assets/js/browser.min.js"></script>
        <script src="assets/js/breakpoints.min.js"></script>
        <script src="assets/js/transition.js"></script>
        <script src="assets/js/owl-carousel.js"></script>
        <script src="assets/js/custom.js"></script>

        <script src="./assets/js/base.js"></script>
        <!-- ä½¿ç”¨jQuery-form.jsæ’ä»¶ -->
        <script src="./assets/js/jquery-form.js"></script>
        <script>
            // å…¨å±€å®šä¹‰çš„id
            var editId, delId

            $(function() {
                // è·å–å…è´¹çš„æ¨èæ™¯ç‚¹
                getSelectedSpots()

                // æ¸¸å®¢èº«ä»½æç¤º
                if (!landed().isLanded) {
                    $('#header').after(`
                    <div
                        class="alert alert-warning alert-dismissible fade show"
                        role="alert"
                        style="margin-bottom: 100px"
                    >
                        æ‚¨ç°åœ¨å¤„äºæ¸¸å®¢çŠ¶æ€è®¿é—®ç½‘ç«™ï¼Œä»…èƒ½è¿›è¡ŒæŸ¥çœ‹å’Œæœç´¢ï¼Œç®¡ç†æ™¯ç‚¹è¯·å…ˆç™»å½•ï¼ï¼
                        <button
                            type="button"
                            class="close"
                            data-dismiss="alert"
                            aria-label="Close"
                        >
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    `)
                    return
                } else {
                    // è·å–å½“å‰ç™»å½•ç”¨æˆ·å‘å¸ƒçš„æ™¯ç‚¹
                    getMySpots(landed().landedUser)
                }

                // ç‚¹å‡»ç™»å‡º
                $('.logo a').click(function() {
                    localStorage.clear('myToken')
                    location.href = 'login.html'
                })
            })

            // æäº¤åˆ é™¤
            function delSubmit() {
                $.ajax({
                    async: false,
                    url: rootPath + '/spots/delSpot',
                    method: 'POST',
                    data: {
                        id: delId
                    },
                    success: function(result) {
                        console.log(result)
                        if (result.code == 200) {
                            $('#delTips')
                                .text('åˆ é™¤æˆåŠŸï¼Œè¯·åˆ·æ–°é¡µé¢')
                                .css('color', 'red')
                        }
                    },
                    error: function(error) {
                        console.log(error)
                    }
                })
            }

            // åˆ é™¤æ™¯ç‚¹
            function delSpot(spotId) {
                $.ajax({
                    async: false,
                    url: rootPath + `/spots/getSpot?id=${spotId}`,
                    method: 'GET',
                    success: function(result) {
                        console.log(result)
                        $(result.data).each(function(index, obj) {
                            $('#delTitle').text(
                                'åˆ é™¤æ™¯ç‚¹ ' + obj.name + ' çš„ä¿¡æ¯'
                            )
                        })
                        // æŠŠå½“å‰ç¼–è¾‘çš„æ™¯ç‚¹çš„idçˆ¶å­ç»™å…¨å±€å˜é‡
                        delId = spotId
                    },
                    error: function(error) {
                        console.log(error)
                    }
                })
            }

            // æäº¤ä¿®æ”¹
            function editSubmit() {
                $('#editForm').ajaxSubmit({
                    async: false,
                    url: rootPath + '/spots/editSpot',
                    method: 'POST',
                    data: {
                        id: editId
                    },
                    success: function(result) {
                        console.log(result)

                        if (result.code == 200) {
                            $('#editTips')
                                .text('ä¿®æ”¹æˆåŠŸï¼Œè¯·åˆ·æ–°é¡µé¢')
                                .css('color', 'red')
                        }
                    },
                    error: function(error) {
                        console.log(error)
                    }
                })
            }

            // ç¼–è¾‘æ™¯ç‚¹æŒ‰é’®äº‹ä»¶
            function editSpot(spotId) {
                $.ajax({
                    async: false,
                    url: rootPath + `/spots/getSpot?id=${spotId}`,
                    method: 'GET',
                    success: function(result) {
                        console.log(result)
                        $(result.data).each(function(index, obj) {
                            $('#modalTitle').text(
                                'ä¿®æ”¹ ' + obj.name + ' çš„ä¿¡æ¯'
                            )
                            $('#ticket').val(obj.ticket)
                            $('#spotDesc').val(obj.describe)
                        })
                        // æŠŠå½“å‰ç¼–è¾‘çš„æ™¯ç‚¹çš„idçˆ¶å­ç»™å…¨å±€å˜é‡
                        editId = spotId
                    },
                    error: function(error) {
                        console.log(error)
                    }
                })
            }

            // è·å–ä¸ªäººå‘å¸ƒçš„æ™¯ç‚¹
            function getMySpots(user) {
                $.ajax({
                    async: false,
                    url: rootPath + `/spots/getMySpots?publisher=${user}`,
                    method: 'GET',
                    success: function(result) {
                        console.log(result)
                        var content = ''

                        // æ¸…ç©ºåŸæœ‰æ•°æ®
                        $('#spotsList').empty()

                        if (result.data.length == 0) {
                            console.log(result.msg)
                            return
                        }

                        // æ•°æ®å¯¹è±¡éå†
                        $(result.data).each(function(index, obj) {
                            let ticket = obj.ticket,
                                seasons,
                                album = staticFile + obj.album

                            if (obj.ticket == 0) {
                                ticket = 'å…è´¹'
                            }
                            switch (obj.seasons) {
                                case 1:
                                    seasons = 'æ˜¥å­£'
                                    break

                                case 2:
                                    seasons = 'å¤å­£'
                                    break

                                case 3:
                                    seasons = 'ç§‹å­£'
                                    break

                                case 4:
                                    seasons = 'å†¬å­£'
                                    break

                                case 5:
                                    seasons = 'æ˜¥ç§‹'
                                    break

                                case 6:
                                    seasons = 'å››å­£çš†å®œ'
                                    break

                                default:
                                    break
                            }

                            // domæ¸²æŸ“
                            content = `
                                <section class="right-image">
                                    <div class="container-fluid">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="left-content">
                                                    <h4>${obj.name}</h4>
                                                    <p>
                                                        ğŸš©åœ°å€ï¼š${obj.position}
                                                    </p>
                                                    <p>
                                                        ğŸ’´ç¥¨ä»·(å…ƒ)ï¼š${ticket}
                                                    </p>
                                                    <p>
                                                        ğŸŒ¤æœ€ä½³æ¸¸ç©å­£èŠ‚ï¼š${seasons}
                                                    </p>
                                                    <p>
                                                        ğŸæ™¯ç‚¹ç®€ä»‹ï¼š${
                                                            obj.describe
                                                        }
                                                    </p>
                                                    <p>
                                                        tipsï¼šæœ¬æ™¯ç‚¹ç”±
                                                        <a href="#">${
                                                            obj.publisher
                                                        }</a>
                                                        äº
                                                        <a href="#">${
                                                            obj.createdAt
                                                        }</a>
                                                        æäº¤å‘ç°ã€‚<br />
                                                        ä¸Šæ¬¡ä¿®æ”¹æ—¶é—´ï¼š${
                                                            obj.updatedAt
                                                        }
                                                    </p>
                                                    <div class="btn-group">
                                                        <div
                                                            class="primary-button"
                                                            style="margin-right: 30px"
                                                        >
                                                            <button
                                                                class="btn btn-primary"
                                                                data-toggle="modal"
                                                                data-target="#editModal"
                                                                onclick="editSpot(${
                                                                    obj.id
                                                                })"
                                                            >
                                                                ç¼–è¾‘æ™¯ç‚¹
                                                            </button>
                                                        </div>
                                                        <div class="danger-button">
                                                            <button
                                                                class="btn btn-danger"
                                                                data-toggle="modal"
                                                                data-target="#delModal"
                                                                onclick="delSpot(${
                                                                    obj.id
                                                                })"
                                                            >
                                                                åˆ é™¤æ™¯ç‚¹
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <img src="${album}" />
                                            </div>
                                        </div>
                                    </div>
                                </section>`
                            // æ‹¼æ¥
                            $('#spotsList').append(content)
                        })
                    },
                    error: function() {
                        console.log(error)
                    }
                })
            }

            // è·å–å…è´¹çš„æ¨èæ™¯ç‚¹
            function getSelectedSpots() {
                $.ajax({
                    async: false,
                    url: rootPath + '/spots/getFreeSpots',
                    method: 'GET',
                    success: function(result) {
                        console.log('è·å–çš„å…è´¹æ¨èæ™¯ç‚¹', result)
                        var selected = ''

                        // æ¸…ç©ºåŸæœ‰æ•°æ®
                        $('#selected').empty()

                        if (result.data.length == 0) {
                            console.log(result.msg)
                            return
                        }
                        // æ•°æ®å¯¹è±¡éå†
                        $(result.data).each(function(index, obj) {
                            let album = staticFile + obj.album

                            selected = `
                                <div class="featured-item">
                                    <img
                                        src="${album}"
                                        alt="${obj.album}"
                                    />
                                    <p>
                                        ${obj.name}
                                    </p>
                                </div>`
                            // DOMç”Ÿæˆ
                            $('#selected').append(selected)
                        })
                    },
                    error: function(error) {
                        console.log(error)
                    }
                })
            }

            // åˆ¤æ–­å½“å‰æ˜¯å¦å·²ç™»é™†
            function landed() {
                var my_token = localStorage.myToken
                var landedStatus = {
                    isLanded: false,
                    landedUser: 'æœªç™»å½•'
                }
                // é¡µé¢åŠ è½½å®Œæˆæ—¶è¯·æ±‚
                $.ajax({
                    async: false,
                    url: rootPath + '/users/current',
                    method: 'GET',
                    headers: {
                        Authorization: my_token
                    },
                    success: function(result) {
                        console.log('æˆåŠŸçš„å›è°ƒï¼š' + result.msg)
                        if (result.code == 200) {
                            // DOMæ¸²æŸ“
                            $('.logo a').text(
                                result.data.username + 'ï¼Œç‚¹å‡»ç™»å‡º'
                            )
                            landedStatus.isLanded = true
                            landedStatus.landedUser = result.data.username
                        }
                    },
                    error: function(error) {
                        console.log(error.statusText)
                    }
                })

                return landedStatus
            }

            // å›¾ç‰‡ä¸Šä¼ é¢„è§ˆ
            $('#album').on('change', function() {
                if (typeof FileReader != 'undefined') {
                    var preview = $('#preview')
                    preview.empty()
                    var reader = new FileReader()
                    reader.onload = function(e) {
                        $('<img />', {
                            src: e.target.result,
                            class: 'thumb-image'
                        }).appendTo(preview)
                    }
                    preview.show()
                    reader.readAsDataURL($(this)[0].files[0])
                } else {
                    alert('æµè§ˆå™¨ä¸æ”¯æŒFileReaderï¼Œè¯·ä½¿ç”¨æ”¯æŒçš„æµè§ˆå™¨ä¸Šä¼ ')
                }
            })
        </script>
    </body>
</html>
