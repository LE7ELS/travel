<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1, shrink-to-fit=no"
        />
        <meta name="description" content="" />
        <meta name="author" content="" />

        <title>æ—…æ¸¸å›¾æ–‡æ•°æ®åº“</title>

        <!-- Bootstrap core CSS -->
        <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet" />

        <!-- Additional CSS Files -->
        <link rel="stylesheet" href="assets/css/fontawesome.css" />
        <link rel="stylesheet" href="assets/css/templatemo-style.css" />
        <link rel="stylesheet" href="assets/css/owl.css" />
    </head>

    <body class="is-preload">
        <!-- Wrapper -->
        <div id="wrapper">
            <!-- Main -->
            <div id="main">
                <div class="inner">
                    <!-- Header -->
                    <header id="header">
                        <div class="logo">
                            <a href="login.html">æ¸¸å®¢ï¼Œè¯·ç™»å½•</a>
                        </div>
                    </header>

                    <!-- Page Heading -->
                    <div class="page-heading">
                        <div class="container-fluid">
                            <div class="row">
                                <div class="col-md-12">
                                    <h1>æœ€æ–°æ™¯ç‚¹</h1>
                                    <p>
                                        ä»¥ä¸‹æ˜¯é©´å‹å‘ç°çš„æœ€æ–°æ™¯ç‚¹ã€‚ğŸ‘£ğŸ‘£ğŸ‘£
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å›¾æ–‡å†…å®¹ -->
                    <div id="spotsList"></div>
                </div>
            </div>

            <!-- Sidebar -->
            <div id="sidebar">
                <div class="inner">
                    <!-- Search Box -->
                    <section id="search" class="alt">
                        <form onsubmit="return false" id="keyWordForm">
                            <input
                                type="text"
                                id="keyword"
                                placeholder="æœç´¢æ™¯ç‚¹..."
                            />
                        </form>
                    </section>

                    <!-- Menu -->
                    <nav id="menu">
                        <ul>
                            <li><a href="index.html">æœ€æ–°æ™¯ç‚¹</a></li>
                            <li><a href="post-add.html">å‘å¸ƒæ–°æ™¯ç‚¹</a></li>
                            <li><a href="post-manage.html">æ™¯ç‚¹ç®¡ç†</a></li>
                        </ul>
                    </nav>

                    <!-- å…è´¹æ™¯ç‚¹æ¨è -->
                    <div class="featured-posts">
                        <div class="heading">
                            <h2>å…è´¹æ™¯ç‚¹æ¨è</h2>
                        </div>
                        <div id="selected" class="owl-carousel owl-theme"></div>
                    </div>

                    <!-- Footer -->
                    <footer id="footer">
                        <p class="copyright">
                            UMLè¯¾è®¾@1600300626ç‹æ°åŸ
                        </p>
                    </footer>
                </div>
            </div>
        </div>

        <!-- Scripts -->
        <!-- Bootstrap core JavaScript -->
        <script src="vendor/jquery/jquery.min.js"></script>
        <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

        <script src="assets/js/browser.min.js"></script>
        <script src="assets/js/breakpoints.min.js"></script>
        <script src="assets/js/transition.js"></script>
        <script src="assets/js/owl-carousel.js"></script>
        <script src="assets/js/custom.js"></script>

        <script src="./assets/js/base.js"></script>
        <script>
            $(function() {
                // æœç´¢å…³é”®è¯
                var searchKeyword = ''

                // æ¸¸å®¢èº«ä»½æç¤º
                if (!isLanded()) {
                    $('#header').after(`
                    <div
                        class="alert alert-warning alert-dismissible fade show"
                        role="alert"
                        style="margin-bottom: 100px"
                    >
                        æ‚¨ç°åœ¨å¤„äºæ¸¸å®¢çŠ¶æ€è®¿é—®ç½‘ç«™ï¼Œä»…èƒ½è¿›è¡ŒæŸ¥çœ‹å’Œæœç´¢ï¼Œå¦‚éœ€ä½¿ç”¨æ›´å¤šåŠŸèƒ½è¯·ç™»å½•ï¼
                        <button
                            type="button"
                            class="close"
                            data-dismiss="alert"
                            aria-label="Close"
                        >
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    `)
                }

                // è·å–æœ€æ–°æ™¯ç‚¹
                getLastestSpots(searchKeyword)
                // è·å–å…è´¹çš„æ¨èæ™¯ç‚¹
                getSelectedSpots()

                // ç‚¹å‡»ç™»å‡º
                $('.logo a').click(function() {
                    localStorage.clear('myToken')
                    location.href = 'login.html'
                })

                // åŠ¨æ€æœç´¢
                $('#keyword').keyup(function(event) {
                    if (event.keyCode == 13) {
                        searchKeyword = $('#keyword').val()

                        // æ ç›®æ ‡é¢˜æ›´æ–°
                        if (searchKeyword == '') {
                            $('.page-heading h1').text('æœ€æ–°æ™¯ç‚¹')
                            $('.page-heading p').text(
                                `ä»¥ä¸‹æ˜¯é©´å‹å‘ç°çš„æœ€æ–°æ™¯ç‚¹ã€‚ğŸ‘£ğŸ‘£ğŸ‘£`
                            )
                        } else {
                            $('.page-heading h1').text('æ™¯ç‚¹æœç´¢')
                            $('.page-heading p').text(
                                `ä»¥ä¸‹æ˜¯åç§°å«æœ‰â€œ${searchKeyword}â€çš„æ™¯ç‚¹ã€‚ğŸ”ğŸ”ğŸ”`
                            )
                        }
                        // è·å–æ•°æ®
                        getLastestSpots(searchKeyword)
                    }
                })
            })

            // è·å–æœ€æ–°æ™¯ç‚¹
            function getLastestSpots(value) {
                $.ajax({
                    async: false,
                    url: rootPath + `/spots/getLastest?name=${value}`,
                    method: 'GET',
                    success: function(result) {
                        console.log('è·å–çš„æœ€æ–°æ™¯ç‚¹', result)
                        var content = ''

                        // æ¸…ç©ºåŸæœ‰æ•°æ®
                        $('#spotsList').empty()

                        if (result.data.length == 0) {
                            console.log(result.msg)
                            return
                        }
                        // æ•°æ®å¯¹è±¡éå†
                        $(result.data).each(function(index, obj) {
                            let ticket = obj.ticket,
                                seasons,
                                album = staticFile + obj.album

                            if (obj.ticket == 0) {
                                ticket = 'å…è´¹'
                            }
                            switch (obj.seasons) {
                                case 1:
                                    seasons = 'æ˜¥å­£'
                                    break

                                case 2:
                                    seasons = 'å¤å­£'
                                    break

                                case 3:
                                    seasons = 'ç§‹å­£'
                                    break

                                case 4:
                                    seasons = 'å†¬å­£'
                                    break

                                case 5:
                                    seasons = 'æ˜¥ç§‹'
                                    break

                                case 6:
                                    seasons = 'å››å­£çš†å®œ'
                                    break

                                default:
                                    break
                            }

                            // domæ¸²æŸ“
                            content = `
                                <section class="left-image">
                                    <div class="container-fluid">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <img
                                                    src="${album}"
                                                />
                                            </div>
                                            <div class="col-md-6">
                                                <div class="right-content">
                                                    <h4>${obj.name}</h4>
                                                    <p>
                                                        ğŸš©åœ°å€ï¼š${obj.position}
                                                    </p>
                                                    <p>
                                                        ğŸ’´ç¥¨ä»·(å…ƒ)ï¼š${ticket}
                                                    </p>
                                                    <p>
                                                        ğŸŒ¤æœ€ä½³æ¸¸ç©å­£èŠ‚ï¼š${seasons}
                                                    </p>
                                                    <p>
                                                        ğŸæ™¯ç‚¹ç®€ä»‹ï¼š${
                                                            obj.describe
                                                        }
                                                    </p>
                                                    <p>
                                                        tipsï¼šæœ¬æ™¯ç‚¹ç”±
                                                        <a href="#">${
                                                            obj.publisher
                                                        }</a> äº
                                                        <a href="#">${
                                                            obj.createdAt
                                                        }</a>
                                                        æäº¤å‘ç°ã€‚<br>
                                                        ä¸Šæ¬¡ä¿®æ”¹æ—¶é—´ï¼š${
                                                            obj.updatedAt
                                                        }
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </section>`
                            // æ‹¼æ¥
                            $('#spotsList').append(content)
                        })
                    },
                    error: function(error) {
                        console.log('é”™è¯¯ï¼š', error)
                    }
                })
            }

            // è·å–å…è´¹çš„æ¨èæ™¯ç‚¹
            function getSelectedSpots() {
                $.ajax({
                    async: false,
                    url: rootPath + '/spots/getFreeSpots',
                    method: 'GET',
                    success: function(result) {
                        console.log('è·å–çš„å…è´¹æ¨èæ™¯ç‚¹', result)
                        var selected = ''

                        // æ¸…ç©ºåŸæœ‰æ•°æ®
                        $('#selected').empty()

                        if (result.data.length == 0) {
                            console.log(result.msg)
                            return
                        }
                        // æ•°æ®å¯¹è±¡éå†
                        $(result.data).each(function(index, obj) {
                            let album = staticFile + obj.album

                            selected = `
                                <div class="featured-item">
                                    <img
                                        src="${album}"
                                        alt="${obj.album}"
                                    />
                                    <p>
                                        ${obj.name}
                                    </p>
                                </div>`
                            // DOMç”Ÿæˆ
                            $('#selected').append(selected)
                        })
                    },
                    error: function(error) {
                        console.log(error)
                    }
                })
            }

            // åˆ¤æ–­å½“å‰æ˜¯å¦å·²ç™»é™†
            function isLanded() {
                var my_token = localStorage.myToken
                console.log('è·å–çš„tokenï¼š', my_token)
                var isLanded = false
                // é¡µé¢åŠ è½½å®Œæˆæ—¶è¯·æ±‚
                $.ajax({
                    async: false,
                    url: rootPath + '/users/current',
                    method: 'GET',
                    headers: {
                        Authorization: my_token
                    },
                    success: function(result) {
                        console.log('æˆåŠŸçš„å›è°ƒï¼š' + result.msg)
                        if (result.code == 200) {
                            // DOMæ¸²æŸ“
                            $('.logo a').text(
                                result.data.username + 'ï¼Œç‚¹å‡»ç™»å‡º'
                            )
                            isLanded = true
                        }
                    },
                    error: function(error) {
                        console.log(error.statusText)
                    }
                })
                return isLanded
            }
        </script>
    </body>
</html>
