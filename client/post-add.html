<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
        <title>å‘å¸ƒæ–°æ™¯ç‚¹</title>

        <!-- Bootstrap core CSS -->
        <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet" />

        <!-- Additional CSS Files -->
        <link rel="stylesheet" href="assets/css/fontawesome.css" />
        <link rel="stylesheet" href="assets/css/templatemo-style.css" />
        <link rel="stylesheet" href="assets/css/owl.css" />
    </head>
    <body>
        <!-- Wrapper -->
        <div id="wrapper">
            <!-- Main -->
            <div id="main">
                <div class="inner">
                    <!-- Header -->
                    <header id="header">
                        <div class="logo">
                            <a href="login.html">æ¸¸å®¢ï¼Œè¯·ç™»å½•</a>
                        </div>
                    </header>

                    <!-- Page Heading -->
                    <div class="page-heading">
                        <div class="container-fluid">
                            <div class="row">
                                <div class="col-md-12">
                                    <h1>å‘å¸ƒæ–°æ™¯ç‚¹</h1>
                                    <p>
                                        åœ¨è¿™é‡Œå‘å¸ƒä½ æ–°å‘ç°çš„å®è—æ™¯ç‚¹å§ï¼
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ™¯ç‚¹å‘å¸ƒè¡¨å• -->
                    <section class="forms">
                        <div class="container-fluid">
                            <div class="row">
                                <div class="col-md-12">
                                    <form
                                        id="newSpotForm"
                                        method="post"
                                        enctype="multipart/form-data"
                                    >
                                        <div class="form-row">
                                            <div class="form-group col-md-6">
                                                <label for="spotName"
                                                    >ğŸ•æ™¯ç‚¹å</label
                                                >
                                                <input
                                                    type="text"
                                                    class="form-control"
                                                    name="spotName"
                                                    id="spotName"
                                                    placeholder="æ™¯ç‚¹å"
                                                    required
                                                />
                                            </div>
                                            <div class="form-group col-md-6">
                                                <label for="publisher"
                                                    >ğŸ§šâ€å‘å¸ƒè€…</label
                                                >
                                                <input
                                                    type="text"
                                                    class="form-control"
                                                    name="publisher"
                                                    id="publisher"
                                                    value="è¯·å…ˆç™»å½•ï¼"
                                                    readonly
                                                />
                                            </div>
                                        </div>

                                        <div class="form-row">
                                            <div class="form-group col-md-6">
                                                <label for="seasons"
                                                    >ğŸŒ¤æœ€ä½³æ¸¸ç©å­£èŠ‚</label
                                                >
                                                <select
                                                    name="seasons"
                                                    id="seasons"
                                                >
                                                    <option value="1"
                                                        >æ˜¥å­£</option
                                                    >
                                                    <option value="2"
                                                        >å¤å­£</option
                                                    >
                                                    <option value="3"
                                                        >ç§‹å­£</option
                                                    >
                                                    <option value="4"
                                                        >å†¬å­£</option
                                                    >
                                                    <option value="5"
                                                        >æ˜¥ç§‹</option
                                                    >
                                                    <option value="6"
                                                        >å››å­£çš†å®œ</option
                                                    >
                                                </select>
                                            </div>

                                            <div class=" form-group col-md-6">
                                                <label for="price"
                                                    >ğŸ’´ç¥¨ä»·</label
                                                >
                                                <div class="input-group">
                                                    <div
                                                        class="input-group-prepend"
                                                    >
                                                        <span
                                                            class="input-group-text"
                                                            >ï¿¥</span
                                                        >
                                                    </div>
                                                    <input
                                                        type="text"
                                                        onkeyup="value=value.replace(/^(-1+)|[^\d]+/g,'')"
                                                        class="form-control"
                                                        name="ticket"
                                                        id="ticket"
                                                        placeholder="ç¥¨ä»·"
                                                        required
                                                    />
                                                    <div
                                                        class="input-group-prepend"
                                                    >
                                                        <span
                                                            class="input-group-text"
                                                            >.00</span
                                                        >
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label for="position">ğŸš©åœ°å€</label>
                                            <input
                                                type="text"
                                                class="form-control"
                                                name="position"
                                                id="position"
                                                placeholder="æ™¯ç‚¹åœ°å€"
                                                required
                                            />
                                        </div>

                                        <div class="form-group">
                                            <label for="spotDesc"
                                                >ğŸæ™¯ç‚¹æè¿°</label
                                            >
                                            <textarea
                                                name="spotDesc"
                                                id="spotDesc"
                                                placeholder="æ™¯ç‚¹æè¿°"
                                                cols="30"
                                                rows="10"
                                                required
                                            ></textarea>
                                        </div>

                                        <div class="input-group mb-5">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"
                                                    >ğŸ•ï¸ä¸Šä¼ æ™¯ç‚¹å›¾ç‰‡</span
                                                >
                                            </div>
                                            <div class="custom-file">
                                                <input
                                                    type="file"
                                                    class="custom-file-input"
                                                    name="album"
                                                    id="album"
                                                    required
                                                />
                                                <label
                                                    class="custom-file-label"
                                                    for="album"
                                                    >ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</label
                                                >
                                            </div>
                                        </div>

                                        <div class="form-group mb-5">
                                            <label for="preview"
                                                >å›¾ç‰‡é¢„è§ˆğŸ‘‡ğŸ‘‡ğŸ‘‡</label
                                            >
                                            <div id="preview"></div>
                                        </div>
                                        <a
                                            href=""
                                            class="btn btn-primary"
                                            onclick="addSpot()"
                                        >
                                            å‘å¸ƒæ™¯ç‚¹
                                        </a>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>

            <!-- sidebar -->
            <div id="sidebar">
                <div class="inner">
                    <!-- Search Box -->
                    <section id="search" class="alt">
                        <form onsubmit="return false" id="keyWordForm">
                            <input
                                type="text"
                                id="keyword"
                                placeholder="æœç´¢æ™¯ç‚¹..."
                            />
                        </form>
                    </section>

                    <!-- Menu -->
                    <nav id="menu">
                        <ul>
                            <li><a href="index.html">æœ€æ–°æ™¯ç‚¹</a></li>
                            <li><a href="post-add.html">å‘å¸ƒæ–°æ™¯ç‚¹</a></li>
                            <li><a href="post-manage.html">æ™¯ç‚¹ç®¡ç†</a></li>
                        </ul>
                    </nav>

                    <!-- Featured Posts -->
                    <div class="featured-posts">
                        <div class="heading">
                            <h2>å…è´¹æ™¯ç‚¹æ¨è</h2>
                        </div>
                        <div id="selected" class="owl-carousel owl-theme"></div>
                    </div>

                    <!-- Footer -->
                    <footer id="footer">
                        <p class="copyright">
                            UMLè¯¾è®¾@1600300626ç‹æ°åŸ
                        </p>
                    </footer>
                </div>
            </div>
        </div>

        <!-- Scripts -->
        <!-- Bootstrap core JavaScript -->
        <script src="vendor/jquery/jquery.min.js"></script>
        <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

        <script src="assets/js/browser.min.js"></script>
        <script src="assets/js/breakpoints.min.js"></script>
        <script src="assets/js/transition.js"></script>
        <script src="assets/js/owl-carousel.js"></script>
        <script src="assets/js/custom.js"></script>

        <script src="./assets/js/base.js"></script>
        <!-- ä½¿ç”¨jQuery-form.jsæ’ä»¶ -->
        <script src="./assets/js/jquery-form.js"></script>
        <script>
            $(function() {
                // æ¸¸å®¢èº«ä»½æç¤º
                if (!landed().isLanded) {
                    $('#header').after(`
                    <div
                        class="alert alert-warning alert-dismissible fade show"
                        role="alert"
                        style="margin-bottom: 100px"
                    >
                        æ‚¨ç°åœ¨å¤„äºæ¸¸å®¢çŠ¶æ€ï¼Œå¦‚éœ€æäº¤æ™¯ç‚¹è¯·å…ˆç™»å½•ï¼
                        <button
                            type="button"
                            class="close"
                            data-dismiss="alert"
                            aria-label="Close"
                        >
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    `)

                    // æäº¤æŒ‰é’®ä¸å¯ç”¨
                    $('#addNewSpot')
                        .attr('disabled', true)
                        .text('è¯·ç™»å½•ï¼')
                } else {
                    $('#publisher').val(`${landed().landedUser}`)
                }

                // è·å–å…è´¹çš„æ¨èæ™¯ç‚¹
                getSelectedSpots()

                // ç‚¹å‡»ç™»å‡º
                $('.logo a').click(function() {
                    localStorage.clear('myToken')
                    location.href = 'login.html'
                })
            })

            // è¡¨å•æäº¤(å«æ–‡ä»¶ä¸Šä¼ )
            function addSpot() {
                console.log('è¡¨å•æäº¤')
                $('#newSpotForm').ajaxSubmit({
                    async: false,
                    url: rootPath + '/spots/addSpot',
                    method: 'POST',
                    success: function(result) {
                        console.log(result.msg)
                        alert(result.msg)
                    },
                    error: function(error) {
                        console.log(error)
                    }
                })
            }

            // è·å–å…è´¹çš„æ¨èæ™¯ç‚¹
            function getSelectedSpots() {
                $.ajax({
                    async: false,
                    url: rootPath + '/spots/getFreeSpots',
                    method: 'GET',
                    success: function(result) {
                        console.log('è·å–çš„å…è´¹æ¨èæ™¯ç‚¹', result)
                        var selected = ''

                        // æ¸…ç©ºåŸæœ‰æ•°æ®
                        $('#selected').empty()

                        if (result.data.length == 0) {
                            console.log(result.msg)
                            return
                        }
                        // æ•°æ®å¯¹è±¡éå†
                        $(result.data).each(function(index, obj) {
                            let album = staticFile + obj.album

                            selected = `
                            <a href="#">
                                <div class="featured-item">
                                    <img
                                        src="${album}"
                                        alt="${obj.album}"
                                    />
                                    <p>
                                        ${obj.name}
                                    </p>
                                </div>
                            </a>`
                            // DOMç”Ÿæˆ
                            $('#selected').append(selected)
                        })
                    },
                    error: function(error) {
                        console.log(error)
                    }
                })
            }

            // å›¾ç‰‡ä¸Šä¼ é¢„è§ˆ
            $('#album').on('change', function() {
                if (typeof FileReader != 'undefined') {
                    var preview = $('#preview')
                    preview.empty()
                    var reader = new FileReader()
                    reader.onload = function(e) {
                        $('<img />', {
                            src: e.target.result,
                            class: 'thumb-image'
                        }).appendTo(preview)
                    }
                    preview.show()
                    reader.readAsDataURL($(this)[0].files[0])
                } else {
                    alert('æµè§ˆå™¨ä¸æ”¯æŒFileReaderï¼Œè¯·ä½¿ç”¨æ”¯æŒçš„æµè§ˆå™¨ä¸Šä¼ ')
                }
            })

            // åˆ¤æ–­å½“å‰æ˜¯å¦å·²ç™»é™†
            function landed() {
                var my_token = localStorage.myToken
                var landedStatus = {
                    isLanded: false,
                    landedUser: 'æœªç™»å½•'
                }
                // é¡µé¢åŠ è½½å®Œæˆæ—¶è¯·æ±‚
                $.ajax({
                    async: false,
                    url: rootPath + '/users/current',
                    method: 'GET',
                    headers: {
                        Authorization: my_token
                    },
                    success: function(result) {
                        console.log('æˆåŠŸçš„å›è°ƒï¼š' + result.msg)
                        if (result.code == 200) {
                            // DOMæ¸²æŸ“
                            $('.logo a').text(
                                result.data.username + 'ï¼Œç‚¹å‡»ç™»å‡º'
                            )
                            landedStatus.isLanded = true
                            landedStatus.landedUser = result.data.username
                        }
                    },
                    error: function(error) {
                        console.log(error.statusText)
                    }
                })

                return landedStatus
            }
        </script>
    </body>
</html>
